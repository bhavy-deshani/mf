<!DOCTYPE html>
<html lang="en-US" dir="ltr">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <!-- ===============================================-->
    <!--    Document Title-->
    <!-- ===============================================-->
    <title>Integratedindia</title>


    <!-- ===============================================-->
    <!--    Favicons-->
    <!-- ===============================================-->
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicons/fiveicon.ico">
    <!-- <meta name="msapplication-TileImage" content="assets/images/favicons/fiveicon.ico"> -->
    <meta name="theme-color" content="#ffffff">
    <!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
  integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"> -->
    <!-- ===============================================-->
    <!--    Stylesheets-->
    <!-- ===============================================-->
    <link href="assets/css/theme.css" rel="stylesheet" />

    <!-- <script src="vendors/fontawesome/all.min.js"></script> -->
    <style>
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <main>
        <script src="assets/js/header.js"></script>
        <script src="assets/js/footer.js"></script>
        <section class="pt-9">
            <div class="container">
                <nav class="opacity-75"
                    style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);"
                    aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="nps-login.html">NPS</a></li>
                        <li class="breadcrumb-item"><a href="cams-nps-service-provider.html">CAMS</a></li>
                        <li class="breadcrumb-item active" aria-current="page">New Registration</li>
                    </ol>
                </nav>
                <div class="row justify-content-between">
                    <div class="col-md-6">
                        <div>
                            <img loading="lazy" class="img-fluid" src="assets/images/gallery/NPS-nsdl-cams.png" alt="">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="col-md-11 border rounded-2 shadow">
                            <div class="col-5 m-auto py-2">
                                <img loading="lazy" class="img-fluid w-100" src="assets/images/gallery/cams-nps.webp"
                                    alt="">
                            </div>
                            <div class="text-center pb-xl-2">
                                <h2 class="text-g">New Registration</h2>
                            </div>
                            <div class="px-xl-5">
                                <form id="mainForm" method="post">
                                    <div class="pb-3">
                                        <input type="text" class="w-100 py-2 rounded-2 border-1" placeholder="Name*"
                                            required name="name" id="name">
                                        <label for="name" class="text-danger fs--2">Name as per PAN Database (ie. Full
                                            Name in First, Middle & Last Name Format)</label>
                                    </div>
                                    <div class="pb-4">
                                        <input type="text" class="w-100 py-2 rounded-2 border-1" placeholder="PAN*"
                                            style="text-transform:uppercase" maxlength="10" minlength="10" required
                                            name="pan" id="pan">
                                    </div>
                                    <div class="pb-4">
                                        <input type="tel" class="w-100 py-2 rounded-2 border-1" id="pran"
                                            placeholder="Mobile No.*"
                                            oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1');"
                                            required>
                                    </div>
                                    <div class="pb-4">
                                        <input type="email" class="w-100 py-2 rounded-2 border-1" placeholder="Email"
                                            name="email" id="email">
                                    </div>
                                    <div class="pb-3">
                                        <select required class="mb-4 w-100 py-2 rounded-2 border-1" id="referredBy"
                                            name="referredBy">
                                            <option value="">Referred by </option>
                                            <option value="integratedBranch">Integrated Branch</option>
                                            <option value="direct">Direct</option>
                                            <!-- Other options -->
                                        </select>
                                        <div id="subMenu" class="hidden">
                                            <select class="mb-xl-4 w-100 py-2 rounded-2 border-1" id="state"
                                                name="state">
                                            </select>
                                            <select class="mb-4 w-100 py-2 rounded-2 border-1" id="city"
                                                name="city">
                                                <option value="">Select City</option>
                                                <!-- City options will be added dynamically -->
                                            </select>
                                            <select class="mb-4 w-100 py-2 rounded-2 border-1" id="cityBranch"
                                                name="cityBranch">
                                                <option value="" disabled>Select Branch</option>
                                                <!-- Branch options will be added dynamically based on the selected city -->
                                            </select>
                                            <input class="mb-xl-4 w-100 py-2 rounded-2 border-1" type="tel"
                                            placeholder="Employee Name" id="EmpName" name="EmpName" >

                                    <input class="mb-xl-4 w-100 py-2 rounded-2 border-1" type="tel"
                                    placeholder="Employee ID" id="EmpId" name="EmpId">
                                        </div>
                                        <div id="directFields" class="hidden">
                                            <div class="mb-4">
                                                <input class="w-100 py-2 rounded-2 border-1" type="tel"
                                                    placeholder="Pincode" id="pincode" name="pincode">
                                            </div>
                                            <div class="mb-4">
                                                <input class="w-100 py-2 rounded-2 border-1" type="text"
                                                    placeholder="City" id="directCity" name="directCity">
                                            </div>
                                            <div class="mb-4">
                                                <input class="w-100 py-2 rounded-2 border-1" placeholder="State"
                                                    type="text" id="directState" name="directState">
                                            </div>
                                        </div>
                                        <select required class="w-100 py-2 rounded-2 border-1" name="language"
                                            id="language-select" onchange="updateText()">
                                            <option value="">My Preferred Language for Consent</option>
                                            <option value="English">English</option>
                                            <option value="Bengali">Bengali</option>
                                            <option value="Gujarathi">Gujarati</option>
                                            <option value="Hindi">Hindi</option>
                                            <option value="Kannada">Kannada</option>
                                            <option value="Malayalam">Malayalam</option>
                                            <option value="Marathi">Marathi</option>
                                            <option value="Tamil">Tamil</option>
                                            <option value="Telugu">Telugu</option>
                                        </select>
                                    </div>
                                    <div id="text-container"></div>
                                </form>
                                <div id="otpContainer" style="display: none;">
                                    <p>A One-Time Password has been sent to your Mobile No <span
                                            id="displayMobile"></span> & Email-Id <span id="displayEmail"></span></p>
                                        <input  class="mb-xl-4 w-100 py-2 rounded-2 border-1"  type="text" id="otpInput" placeholder="Enter OTP">
                                        <button class="mb-xl-4 bg-b text-white py-xl-1  px-xl-5 rounded-4 border-0 text-center" id="verifyOTPBtn" class="">Submit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script type="text/javascript" src="https://www.integratedindia.in/Scripts/jquery.js"></script>

  <script src="assets/js/jquery-3.5.1.js"></script>
  <script src="vendors/@popperjs/popper.min.js"></script>
  <script src="vendors/bootstrap/bootstrap.min.js"></script>    <script src="assets/js/theme.js"></script>

  <script src="assets/js/chartbot.js"></script>
    <script src="assets/js/nps-form.js"></script>
    <script>
        $("#referredBy").change(function(){
            //const reerred = document.getElementById("referredBy").value;
            if($("#referredBy").val() == "direct")
            {
                $("#city,#state,#cityBranch").val("0");
                $("#city,#state,#cityBranch").prop("required", false);
                $("#pincode,#directState").attr("required", "true");
            }
            else
            {
                $("#pincode,#directState,#directCity").val("");
                $("#pincode,#directState").prop("required", false);
                $("#city,#state,#cityBranch").attr("required", "true");
            }
        })

        $("#pincode").blur(function(){
            if($("#pincode").val().length == "6")
            {
                $("#directCity,#directState").val("");
                $("#state,#city,#cityBranch").html("");
                fetch('https://www.integratedindia.in/api/RBLAPI.aspx',{
                method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            Type : "PINCODE",
                            Pincode : $("#pincode").val()})
                        })
                .then(response => response.json())
                .then(data => {
                    if(data != "")
                    {
                        const PinCodeData=$.parseJSON(data);
                        data.forEach((Pincode, index) => {
                            $("#directCity").val(Pincode.regionname);
                            $("#directState").val(Pincode.statename);
                            $("#directState").attr("statecode",Pincode.Iep_State_Code);
                            $("#directCity,#directState").prop("disabled",true);
                        });
                    }
                    else
                    {
                        $("#directCity,#directState").val("");
                        $("#directCity,#directState").prop("disabled",false);
                    }
                });
            }
        });
         $("#state,#city,#cityBranch").html("");
        fetch('https://www.integratedindia.in/api/RBLAPI.aspx',{
            method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        Type: "NPS",})
                    })
            .then(response => response.json())
            .then(data => {
                $("#state").append("<option value='0'>--Select State--</option>");
                const StateData=$.parseJSON(data.Data1[0].Region);
                StateData.forEach((state, index) => {
                    //const statesDDL = document.getElementById('state');
                    $("#state").append("<option value='"+state.Rgn_Code+"'>"+state.RGN_NAME+"</option>");
                });
                $("#state").change(function(){
                    $("#city,#cityBranch").html("");
                    $("#city").append("<option value='0'>--Select City--</option>");
                    var lastcity="";
                    const CityData=$.parseJSON(data.Data2[0].Rgn_Brn_City_Data);
                    CityData.forEach((cityobj, index) => {
                       // alert(cityobj.Rgn_Code)
                       //alert($('#state option:selected').val())
                      // alert(cityobj.Rgn_Code)
                      if(cityobj.Rgn_Code == $('#state option:selected').val() && cityobj.City != undefined && cityobj.City !=lastcity)
                        {
                           // alert(cityobj.Rgn_Code+cityobj.City)
                            $("#city").append("<option value='"+cityobj.City+"'>"+cityobj.City+"</option>");
                            lastcity=cityobj.City;
                        }
                    })
                });
                $("#city").change(function(){
                    $("#cityBranch").html("");
                    $("#cityBranch").append("<option value='0'>--Select Branch--</option>");
                    const CityData=$.parseJSON(data.Data2[0].Rgn_Brn_City_Data);
                    CityData.forEach((cityobj, index) => {
                        if(cityobj.City == $('#city option:selected').text())
                        {
                            $("#cityBranch").append("<option value='"+cityobj.Brn_Code+"'>"+cityobj.Brn_Name+"</option>");
                        }
                    })
                });
            });
           


        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById("mainForm");
            form.addEventListener("submit", handleFormSubmit);

            function handleFormSubmit(event) {
                event.preventDefault(); // Prevent the default form submission
                // Perform form validation
                if (formIsValid()) {
                    // Get location before sending data to the server
                    getLocation().then(location => {
                        // Send a request to the server to save data and generate/send the OTP
                        saveDataAndSendOTPRequest(location).then(showOTPModal).catch(handleError);
                    }).catch(handleError);
                } else {
                    // Display validation errors
                    displayValidationErrors();
                }
            }

            function getLocation() {
                return new Promise((resolve, reject) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            const latitude = position.coords.latitude;
                            const longitude = position.coords.longitude;
                            const altitude = position.coords.altitude;
                            const accuracy = position.coords.accuracy;
                            resolve({ latitude, longitude, altitude, accuracy });
                        }, error => {
                            reject("Error getting location: " + error.message);
                        });
                    } else {
                        reject("Geolocation is not supported by this browser.");
                    }
                });
            }

            function saveDataAndSendOTPRequest(location) {
                var state,city;
                const mobileNo = document.getElementById("pran").value;
                const email = document.querySelector('input[placeholder="Email"]').value;
                const name = document.querySelector('input[placeholder="Name*"]').value;
                const pan = document.querySelector('input[placeholder="PAN*"]').value;
                const referredBy = document.getElementById("referredBy").value;
                if(referredBy == "direct")
                {
                    state = $("#directState").attr("statecode");
                    city = document.getElementById("directCity").value;
                }
                else
                {
                    state = document.getElementById("state").value;
                    city = document.getElementById("city").value;
                }
                const branch = document.getElementById("cityBranch").value;
                const language = document.getElementById("language-select").value;

                return fetch("https://www.integratedindia.in/api/CDSLAPI.aspx", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        Type: "NPSREG",
                        Mobile: mobileNo,
                        Mode: "DATASAVE",
                        SaveInd: "1",
                        EmailID: email,
                        Name: name,
                        PinCode: $("#pincode").val(), // Assuming a placeholder
                        Panno: pan,
                        Refered: referredBy,
                        State: state,
                        City: city,
                        Branch: branch,
                        EmpID: $("#EmpId").val(), // Placeholder
                        EmpName: $("#EmpName").val(), // Pla
                        Lng: language,
                        Status: "1",
                        RefNo: "1", // Initially setting RefNo to "1" or generate a unique reference number
                        GLAT: location.latitude.toString(), // Using location data
                        GLNG: location.longitude.toString(), // Using location data
                        GACC: location.accuracy.toString(), // Using location data
                        GALT: location.altitude !== null ? location.altitude.toString() : "0", // Using location data
                        Provider: "CAMS"
                    }),
                })
                    .then((response) => {
                        if (!response.ok) {
                            return Promise.reject("Network response was not ok.");
                        }
                        return response.json();
                    })
                    .then((data) => {
                        if (data.ErrorCode === "0") {
                            // Store the reference number for later use
                            document.getElementById("otpContainer").dataset.refNo = data.RefNo;
                            return Promise.resolve();
                        } else {
                            return Promise.reject(data.Msg);
                        }
                    })
                    .catch((error) => {
                        console.error("Error during fetch:", error);
                        return Promise.reject(error);
                    });
            }

            function showOTPModal() {
                const mobileNo = document.getElementById("pran").value;
                const email = document.querySelector('input[placeholder="Email"]').value;

                // Hide the form
                document.getElementById("mainForm").style.display = "none";

                // Display the OTP container with mobile number and email
                document.getElementById("otpContainer").style.display = "block";
                document.getElementById("displayMobile").textContent = `+9********${mobileNo.slice(-4)}`;
                document.getElementById("displayEmail").textContent = email.replace(/^(.{2})(.*)(.@.*)$/, "$1***$3");

                // Add event listener to the Verify OTP button
                const verifyOTPBtn = document.getElementById("verifyOTPBtn");
                verifyOTPBtn.addEventListener("click", verifyOTP);
            }

            function verifyOTP() {
                const otpInput = document.getElementById("otpInput").value;
                const refNo = document.getElementById("otpContainer").dataset.refNo;

                fetch("https://www.integratedindia.in/api/CDSLAPI.aspx", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        Type: "NPSREG",
                        Mode: "OTPVERIFY",
                        RefNo: refNo,
                        ENTEREDOTP: otpInput
                    }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.ErrorCode === "0") {
                            // OTP verification successful, proceed with form submission
                            //document.getElementById("mainForm").submit();
                            window.location.href="https://app.camsnps.com/CRA/auth/enps/register?source=eNPS&users=Integrated_Enterprises";
                        } else {
                            // OTP verification failed, display an error message
                            handleError(data.Msg);
                        }
                    })
                    .catch((error) => handleError(error));
            }

            function handleError(error) {
                // Display the error message to the user
                console.error(error);
                alert(error);
            }

            function formIsValid() {
                let isValid = true;
                const nameInput = document.querySelector('input[placeholder="Name*"]');
                const panInput = document.querySelector('input[placeholder="PAN*"]');
                const mobileInput = document.getElementById("pran");
                const emailInput = document.querySelector('input[placeholder="Email"]');

                // Clear previous validation errors
                clearValidationErrors();

                // Validate name
                if (nameInput.value.trim() === "") {
                    isValid = false;
                    setInputError(nameInput, "Please enter your name");
                }

                // Validate PAN
                const panRegex = /^[A-Za-z]{5}\d{4}[A-Za-z]{1}$/;
                if (!panRegex.test(panInput.value.trim())) {
                    isValid = false;
                    setInputError(panInput, "Please enter a valid PAN number");
                }

                // Validate mobile number
                const mobileRegex = /^\d{10}$/;
                if (!mobileRegex.test(mobileInput.value.trim())) {
                    isValid = false;
                    setInputError(mobileInput, "Please enter a valid 10-digit mobile number");
                }

                // Validate email (optional)
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailInput.value.trim() !== "" && !emailRegex.test(emailInput.value.trim())) {
                    isValid = false;
                    setInputError(emailInput, "Please enter a valid email address");
                }

                return isValid;
            }

            function setInputError(input, errorMessage) {
                const errorElement = document.createElement("div");
                errorElement.classList.add("error-message");
                errorElement.textContent = errorMessage;
                input.parentNode.appendChild(errorElement);
            }

            function clearValidationErrors() {
                const errorMessages = document.querySelectorAll(".error-message");
                errorMessages.forEach((errorMessage) => errorMessage.remove());
            }

            function displayValidationErrors() {
                // Add code to display validation errors to the user
                // You can create a separate container or use alert messages
                alert("Please fix the validation errors and try again.");
            }
        });


    </script>
</body>

</html>